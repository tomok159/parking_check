<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>駐車場チェック</title>

<style>
body{
  font-family:sans-serif;
  text-align:center;
  padding:20px;
}

#grid{
  display:grid;
  grid-template-columns: repeat(5,60px);
  gap:10px;
  justify-content:center;
  margin-top:20px;
}

.cell{
  width:60px;
  height:60px;
  border:2px solid #333;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  background:#8f8;
}

.full{
  background:#f66;
  color:white;
}

canvas{
  display:none;
}
</style>
</head>

<body>

<h2>駐車場 自動判定（写真アップ）</h2>

<input type="file" id="imgInput" accept="image/*">

<div id="grid"></div>

<canvas id="cv"></canvas>

<script>
const grid = document.getElementById("grid");
for(let i=0;i<10;i++){
  const d=document.createElement("div");
  d.className="cell";
  d.textContent=i+1;
  grid.appendChild(d);
}

document.getElementById("imgInput").onchange = e=>{
  const file = e.target.files[0];
  if(!file) return;

  const img = new Image();
  img.onload = ()=>analyze(img);
  img.src = URL.createObjectURL(file);
};

function analyze(img){
  const cv = document.getElementById("cv");
  const ctx = cv.getContext("2d");

  cv.width = img.width;
  cv.height = img.height;
  ctx.drawImage(img,0,0);

  const w = img.width;
  const h = img.height;

  // 君の図専用パラメータ
  const rows = 5;
  const leftX = w * 0.28;
  const rightX = w * 0.68;
  const colW = w * 0.12;
  const cellH = h / rows;

  const cells = document.querySelectorAll(".cell");

  for(let r=0;r<rows;r++){
    checkCell(leftX, r, r);
    checkCell(rightX, r, r+5);
  }

  function checkCell(cx, r, idx){
    const data = ctx.getImageData(
      cx,
      r*cellH + cellH*0.25,
      colW,
      cellH*0.5
    ).data;

    let sum=0;
    for(let i=0;i<data.length;i+=4){
      sum += data[i] + data[i+1] + data[i+2];
    }

    const avg = sum/(data.length/4)/3;

    if(avg < 220){
      cells[idx].classList.add("full");
      cells[idx].textContent = "満";
    }else{
      cells[idx].classList.remove("full");
      cells[idx].textContent = "空";
    }

    console.log("cell", idx, "brightness", avg);
  }
}
</script>

</body>
</html>
