<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>駐車場 自動判定</title>

<style>
body{
  font-family:sans-serif;
  text-align:center;
  padding:20px;
}

#preview{
  max-width:300px;
  margin:10px auto;
  display:block;
}

#grid{
  display:grid;
  grid-template-columns: repeat(5,60px);
  gap:10px;
  justify-content:center;
  margin-top:20px;
}

.cell{
  width:60px;
  height:60px;
  border:2px solid #333;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  background:#8f8;
}

.full{
  background:#f66;
  color:white;
}

#result{
  margin-top:15px;
  font-size:18px;
  font-weight:bold;
}

canvas{ display:none; }
</style>
</head>

<body>

<h2>駐車場 写真→自動判定</h2>

<input type="file" id="imgInput" accept="image/*">

<img id="preview">

<div id="grid"></div>
<div id="result"></div>

<canvas id="cv"></canvas>

<script>
const grid = document.getElementById("grid");
for(let i=0;i<10;i++){
  const d=document.createElement("div");
  d.className="cell";
  d.textContent=i+1;
  grid.appendChild(d);
}

document.getElementById("imgInput").onchange = e=>{
  const file = e.target.files[0];
  if(!file) return;

  const img = new Image();
  img.onload = ()=>{
    document.getElementById("preview").src = img.src;
    analyze(img); // ← 自動実行
  };
  img.src = URL.createObjectURL(file);
};

function analyze(img){
  const cv = document.getElementById("cv");
  const ctx = cv.getContext("2d");

  cv.width = img.width;
  cv.height = img.height;
  ctx.drawImage(img,0,0);

  const w = img.width;
  const h = img.height;

  const rows = 5;

  // 君の手書き図に合わせた座標
  const leftX  = w * 0.25;
  const rightX = w * 0.65;
  const colW   = w * 0.15;
  const cellH  = h / rows;

  const cells = document.querySelectorAll(".cell");

  let fullCount = 0;

  for(let r=0;r<rows;r++){
    check(leftX, r, r);
    check(rightX, r, r+5);
  }

  function check(cx, r, idx){
    const data = ctx.getImageData(
      cx,
      r*cellH + cellH*0.3,
      colW,
      cellH*0.4
    ).data;

    let dark=0;

    for(let i=0;i<data.length;i+=4){
      const v = (data[i]+data[i+1]+data[i+2])/3;
      if(v < 220) dark++;
    }

    const ratio = dark / (data.length/4);

    if(ratio > 0.15){ // 暗いピクセルが一定以上 → 車あり
      cells[idx].classList.add("full");
      cells[idx].textContent="満";
      fullCount++;
    }else{
      cells[idx].classList.remove("full");
      cells[idx].textContent="空";
    }

    console.log("cell", idx, "darkRatio", ratio);
  }

  document.getElementById("result").textContent =
    `満車: ${fullCount} / 10`;
}
</script>

</body>
</html>
